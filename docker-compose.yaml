services:
  mongodb:
    image: mongo:7.0
    container_name: wider-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: wider123
      MONGO_INITDB_DATABASE: wider-builder
    ports:
      - '27017:27017'
    volumes:
      - mongodb_data:/data/db
      - ./mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    networks:
      - wider-network

  app-dev:
    image: bolt-ai:development
    build:
      context: .
      target: bolt-ai-development
    ports:
      - '5173:5173'
    dns:
      - 8.8.8.8
      - 8.8.4.4
      - 1.1.1.1
    env_file: '.env.local'
    environment:
      - NODE_ENV=development
      - VITE_HMR_PROTOCOL=ws
      - VITE_HMR_HOST=localhost
      - VITE_HMR_PORT=5173
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
      - PORT=5173
      - RUNNING_IN_DOCKER=true
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}

      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION:-eu-west-2}
      - AWS_AMPLIFY_BUCKET=${AWS_AMPLIFY_BUCKET:-wider-ai-websites}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - VITE_GITHUB_ACCESS_TOKEN=${VITE_GITHUB_ACCESS_TOKEN}
      - VITE_GITHUB_TOKEN_TYPE=${VITE_GITHUB_TOKEN_TYPE:-classic}
      - MONGODB_CONNECTION_STRING=${MONGODB_CONNECTION_STRING}
      - MONGODB_URI=${MONGODB_URI}
      - API_ROOT_URL=${API_ROOT_URL:-http://localhost:5173}
      - WIDER_APP_URL=${WIDER_APP_URL:-http://localhost:5173}
      - VITE_LOG_LEVEL=${VITE_LOG_LEVEL:-debug}
      - DEFAULT_NUM_CTX=${DEFAULT_NUM_CTX:-32768}
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    volumes:
      - type: bind
        source: .
        target: /app
        consistency: cached
      - /app/node_modules
    command: pnpm run dev --host 0.0.0.0
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:5173/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      - mongodb
    networks:
      - wider-network
    profiles: ['development', 'default']

networks:
  wider-network:
    driver: bridge

volumes:
  mongodb_data:
